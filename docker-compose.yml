version: '3'

services:
  medtracker:
    image: ghcr.io/korjavin/medicationtrackerbot:latest
    container_name: medtracker
    restart: unless-stopped
    volumes:
      - medtracker_data:/app/data
      - telegram_bot_api_data:/var/lib/telegram-bot-api
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
      - DB_PATH=${DB_PATH:-/app/data/meds.db}
      - PORT=${PORT:-8080}
      - TZ=${TZ:-Europe/Berlin}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - TELEGRAM_API_ENDPOINT=${TELEGRAM_API_ENDPOINT:-}
    networks:
      - default
      - traefik_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.medtracker.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.medtracker.entrypoints=websecure"
      - "traefik.http.routers.medtracker.tls.certresolver=myresolver"
      - "traefik.http.services.medtracker.loadbalancer.server.port=${PORT:-8080}"

  mcp-server:
    image: ghcr.io/korjavin/medicationtrackerbot:latest
    container_name: medtracker-mcp
    restart: unless-stopped
    command: ["./mcptool"]
    volumes:
      - medtracker_data:/app/data:ro
    environment:
      - MCP_PORT=${MCP_PORT:-8081}
      - MCP_DATABASE_PATH=${MCP_DATABASE_PATH:-/app/data/meds.db}
      - MCP_MAX_QUERY_DAYS=${MCP_MAX_QUERY_DAYS:-90}
      - MCP_SERVER_URL=${MCP_SERVER_URL}
      - MCP_ALLOWED_SUBJECT=${MCP_ALLOWED_SUBJECT}
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
      # Pocket-ID
      - POCKET_ID_URL=${POCKET_ID_URL}
      - POCKET_ID_CLIENT_ID=${POCKET_ID_CLIENT_ID}
      - POCKET_ID_CLIENT_SECRET=${POCKET_ID_CLIENT_SECRET}
      - POCKET_ID_JWKS_JSON=${POCKET_ID_JWKS_JSON}
      - SKIP_PERMS_FIX=true
      - TZ=${TZ:-Europe/Berlin}
    networks:
      - default
      - traefik_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.medtracker-mcp.rule=Host(`${MCP_DOMAIN}`)"
      - "traefik.http.routers.medtracker-mcp.entrypoints=websecure"
      - "traefik.http.routers.medtracker-mcp.tls.certresolver=myresolver"
      - "traefik.http.services.medtracker-mcp.loadbalancer.server.port=${MCP_PORT:-8081}"

  # Local Telegram Bot API Server - removes 20MB file download limit
  telegram-bot-api:
    image: aiogram/telegram-bot-api:latest
    container_name: medtracker-telegram-api
    restart: unless-stopped
    # Default entrypoint forces user 101. We override it to run our own setup.
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Create appuser (1000) manually by modifying /etc/passwd if not exists
        # This avoids dependency on adduser/useradd which are missing in minimal images
        grep -q :1000: /etc/group || echo "appgroup:x:1000:" >> /etc/group
        grep -q :1000: /etc/passwd || echo "appuser:x:1000:1000:appuser:/var/lib/telegram-bot-api:/bin/sh" >> /etc/passwd
        
        # Fix permissions so appuser can write
        chown -R 1000:1000 /var/lib/telegram-bot-api
        
        # Run server, telling it to switch to our new user
        # We start as root, let the binary drop privileges to appuser (1000)
        exec telegram-bot-api --local \
          --api-id=$${TELEGRAM_API_ID} \
          --api-hash=$${TELEGRAM_API_HASH} \
          --dir=/var/lib/telegram-bot-api \
          --temp-dir=/tmp \
          --username=appuser \
          --groupname=appgroup \
          --http-port=8081
    volumes:
      - telegram_bot_api_data:/var/lib/telegram-bot-api
    environment:
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_LOCAL=1

    ports:
      - "8082:8081"
    networks:
      - default

  # Litestream - SQLite replication to Cloudflare R2
  litestream:
    image: litestream/litestream:latest
    container_name: medtracker-litestream
    restart: unless-stopped
    entrypoint: /bin/sh
    command:
      - -c
      - |
        cat << EOF > /tmp/litestream.yml
        dbs:
          - path: /app/data/meds.db
            replicas:
              - type: s3
                bucket: $${R2_BUCKET}
                path: medtracker
                endpoint: $${R2_ENDPOINT}
                sync-interval: 1h
                snapshot-interval: 24h
                retention: 168h
        EOF
        exec litestream replicate -config /tmp/litestream.yml
    volumes:
      - medtracker_data:/app/data
    environment:
      - LITESTREAM_ACCESS_KEY_ID=${LITESTREAM_ACCESS_KEY_ID}
      - LITESTREAM_SECRET_ACCESS_KEY=${LITESTREAM_SECRET_ACCESS_KEY}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_BUCKET=${R2_BUCKET}
    depends_on:
      - medtracker

networks:
  traefik_net:
    external: true
    name: ${NETWORK_NAME}

volumes:
  medtracker_data:
  telegram_bot_api_data:
