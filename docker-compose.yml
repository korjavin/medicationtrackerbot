version: '3'

services:
  medtracker:
    image: ghcr.io/korjavin/medicationtrackerbot:latest
    container_name: medtracker
    restart: unless-stopped
    volumes:
      - medtracker_data:/app/data
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
      - DB_PATH=${DB_PATH:-/app/data/meds.db}
      - PORT=${PORT:-8080}
      - TZ=${TZ:-Europe/Berlin}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
    networks:
      - default
      - traefik_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.medtracker.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.medtracker.entrypoints=websecure"
      - "traefik.http.routers.medtracker.tls.certresolver=myresolver"
      - "traefik.http.services.medtracker.loadbalancer.server.port=${PORT:-8080}"

  # Litestream - SQLite replication to Cloudflare R2
  litestream:
    image: litestream/litestream:latest
    container_name: medtracker-litestream
    restart: unless-stopped
    entrypoint: /bin/sh
    command:
      - -c
      - |
        cat << EOF > /tmp/litestream.yml
        dbs:
          - path: /app/data/meds.db
            replicas:
              - type: s3
                bucket: $${R2_BUCKET}
                path: medtracker
                endpoint: $${R2_ENDPOINT}
                sync-interval: 1h
                snapshot-interval: 24h
                retention: 168h
        EOF
        exec litestream replicate -config /tmp/litestream.yml
    volumes:
      - medtracker_data:/app/data
    environment:
      - LITESTREAM_ACCESS_KEY_ID=${LITESTREAM_ACCESS_KEY_ID}
      - LITESTREAM_SECRET_ACCESS_KEY=${LITESTREAM_SECRET_ACCESS_KEY}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_BUCKET=${R2_BUCKET}
    depends_on:
      - medtracker

networks:
  traefik_net:
    external: true
    name: ${NETWORK_NAME}

volumes:
  medtracker_data:
