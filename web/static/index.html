<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Med Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>window.BOT_USERNAME = "BOT_USERNAME_PLACEHOLDER";</script>
    <link rel="stylesheet" href="static/css/styles.css?v=TIMESTAMP_PLACEHOLDER">
    <style>
        /* Fallback if css doesn't load immediately */
        body {
            font-family: -apple-system, BlinkMacMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>

<body>
    <div id="app">
        <header>
            <h1>My Medications</h1>
        </header>

        <div id="tabs">
            <button class="tab active" onclick="switchTab('bp')">Blood Pressure</button>
            <button class="tab" onclick="switchTab('weight')">Weight</button>
            <button class="tab" onclick="switchTab('meds')">Medications</button>
            <button class="tab" onclick="switchTab('history')">History</button>
        </div>

        <div id="meds-view" class="view active">
            <div id="weekly-hub-container"></div>
            <div id="med-list">
                <!-- Meds injected here -->
            </div>
            <button id="add-btn" onclick="showAddModal()">+ Add Medication</button>
        </div>

        <div id="history-view" class="view">
            <h3>Intake History</h3>

            <div class="filters">
                <select id="history-filter-med" onchange="loadHistory()">
                    <option value="0">All Medications</option>
                </select>
                <select id="history-filter-days" onchange="loadHistory()">
                    <option value="1">Last 24 Hours</option>
                    <option value="3" selected>Last 3 Days</option>
                    <option value="7">Last 7 Days</option>
                </select>
            </div>

            <div id="history-list"></div>
        </div>

        <div id="bp-view" class="view">
            <h3>Blood Pressure Readings</h3>
            <div class="bp-actions">
                <button onclick="showBPRecordModal()" class="primary">+ Record BP</button>
            </div>
            <div id="bpChart"></div>
            <div id="bp-averages"></div>
            <ul id="bp-list"></ul>
        </div>

        <div id="weight-view" class="view">
            <h3>Weight Tracking</h3>
            <div class="weight-actions">
                <button onclick="showWeightModal()" class="primary">+ Log Weight</button>
            </div>
            <div id="weightChart"></div>
            <div id="weight-stats"></div>
            <ul id="weight-list"></ul>
        </div>
    </div>

    <!-- Modal for Adding Med -->
    <div id="modal-overlay" class="hidden"></div>
    <div id="med-modal" class="hidden">
        <h3>Add Medication</h3>
        <input type="text" id="med-name" placeholder="Name (e.g. Aspirin)">
        <input type="text" id="med-dosage" placeholder="Dosage (e.g. 100mg)">
        <p id="med-rx-display" style="font-size: 0.85em; color: var(--hint-color); margin-top: 5px; display: none;"></p>

        <label>Schedule Type:</label>
        <select id="schedule-type" onchange="toggleScheduleFields()">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="as_needed">As Needed</option>
        </select>

        <div id="days-container" class="hidden">
            <label>Days:</label>
            <div class="days-select">
                <span data-day="1" onclick="toggleDay(this)">Mon</span>
                <span data-day="2" onclick="toggleDay(this)">Tue</span>
                <span data-day="3" onclick="toggleDay(this)">Wed</span>
                <span data-day="4" onclick="toggleDay(this)">Thu</span>
                <span data-day="5" onclick="toggleDay(this)">Fri</span>
                <span data-day="6" onclick="toggleDay(this)">Sat</span>
                <span data-day="0" onclick="toggleDay(this)">Sun</span>
            </div>
        </div>

        <div id="times-container">
            <label>Times:</label>
            <div id="time-inputs">
                <div class="time-row">
                    <input type="time" class="med-time-input">
                    <button class="remove-time" onclick="removeTime(this)">Ã—</button>
                </div>
            </div>
            <button class="small-btn" onclick="addTimeInput()">+ Add Time</button>
        </div>

        <div class="form-row">
            <label>Start Date (Optional):</label>
            <input type="date" id="med-start-date">
        </div>
        <div class="form-row">
            <label>End Date (Optional):</label>
            <input type="date" id="med-end-date">
        </div>

        <div class="inventory-section">
            <label class="checkbox-label">
                <input type="checkbox" id="med-track-inventory" onchange="toggleInventoryFields()"> Track Inventory
            </label>
            <div id="inventory-fields" class="hidden">
                <div class="form-row">
                    <label>Current Stock (doses):</label>
                    <input type="number" id="med-inventory-count" min="0" placeholder="e.g. 30">
                </div>
                <div id="restock-section">
                    <div class="form-row">
                        <label>Quick Restock:</label>
                        <div class="restock-row">
                            <input type="number" id="restock-qty" min="1" placeholder="Qty">
                            <button type="button" class="small-btn" onclick="handleRestock()">+ Add</button>
                        </div>
                    </div>
                    <div id="restock-history" class="restock-history"></div>
                </div>
            </div>
        </div>

        <div class="form-row">
            <label class="checkbox-label">
                <input type="checkbox" id="med-archived"> Archived
            </label>
        </div>

        <div class="actions">
            <button onclick="closeModal()" class="secondary">Cancel</button>
            <button onclick="saveMedication()" class="primary">Save</button>
        </div>
    </div>

    <!-- Modal for BP Recording -->
    <div id="bp-modal" class="hidden">
        <div class="modal-header">
            <h3 id="bp-modal-title">Record Blood Pressure</h3>
            <div class="actions">
                <button type="button" onclick="closeBPRecordModal()" class="secondary">Cancel</button>
                <button type="submit" form="bp-form" class="primary">Save</button>
            </div>
        </div>
        <form id="bp-form" onsubmit="handleBPSubmit(event)">
            <input type="datetime-local" id="bp-datetime" required>
            <div class="bp-inputs-row">
                <div class="bp-input-group">
                    <label>Systolic</label>
                    <input type="number" id="bp-systolic" min="60" max="250" placeholder="120" required
                        inputmode="numeric">
                </div>
                <div class="bp-input-group">
                    <label>Diastolic</label>
                    <input type="number" id="bp-diastolic" min="40" max="150" placeholder="80" required
                        inputmode="numeric">
                </div>
            </div>
            <div class="bp-inputs-row">
                <div class="bp-input-group">
                    <label>Pulse (optional)</label>
                    <input type="number" id="bp-pulse" min="30" max="250" placeholder="70" inputmode="numeric">
                </div>
            </div>
            <div class="form-row">
                <label>Site:</label>
                <select id="bp-site">
                    <option value="right_arm">Right Arm</option>
                    <option value="left_arm">Left Arm</option>
                </select>
            </div>
            <div class="form-row">
                <label>Position:</label>
                <select id="bp-position">
                    <option value="seated">Seated</option>
                    <option value="horizontal">Horizontal</option>
                </select>
            </div>
            <div class="form-row">
                <label>Notes:</label>
                <textarea id="bp-notes" placeholder="Any notes..." rows="3"></textarea>
            </div>
        </form>
    </div>

    <!-- Modal for Weight Logging -->
    <div id="weight-modal" class="hidden">
        <h3>Log Weight</h3>
        <form onsubmit="handleWeightSubmit(event)">
            <input type="datetime-local" id="weight-datetime" required>
            <div class="form-row">
                <label>Weight (kg):</label>
                <input type="number" id="weight-value" step="0.1" min="30" max="300" placeholder="75.5" required>
            </div>
            <div class="form-row">
                <label>Notes (optional):</label>
                <textarea id="weight-notes" placeholder="Any notes..." rows="2"></textarea>
            </div>
            <div class="actions">
                <button type="button" onclick="closeWeightModal()" class="secondary">Cancel</button>
                <button type="submit" class="primary">Save</button>
            </div>
        </form>
    </div>

    <script src="static/js/app.js?v=TIMESTAMP_PLACEHOLDER"></script>
    <div style="text-align:center;color:var(--hint-color);font-size:10px;padding:10px;">
        v: VERSION_PLACEHOLDER
    </div>
</body>

</html>