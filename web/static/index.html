<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2481cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Med Tracker">
    <title>Med Tracker</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.min.js"></script>
    <script>window.BOT_USERNAME = "BOT_USERNAME_PLACEHOLDER";</script>
    <script>window.OIDC_CONFIG = OIDC_CONFIG_PLACEHOLDER;</script>
    <link rel="stylesheet" href="static/css/styles.css?v=TIMESTAMP_PLACEHOLDER">
    <style>
        /* Fallback if css doesn't load immediately */
        body {
            font-family: -apple-system, BlinkMacMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>

<body>
    <div id="app">
        <header>
            <h1>My Medications</h1>
        </header>

        <!-- Sync Status Bar -->
        <div id="sync-status-bar" class="sync-status-bar" style="display: none;"></div>

        <div id="tabs">
            <button class="tab active" onclick="switchTab('bp')">Blood Pressure</button>
            <button class="tab" onclick="switchTab('weight')">Weight</button>
            <button class="tab" onclick="switchTab('workouts')">Workouts</button>
            <button class="tab" onclick="switchTab('meds')">Medications</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <div id="meds-view" class="view active">
            <div id="weekly-hub-container"></div>
            <div id="med-list">
                <!-- Meds injected here -->
            </div>
            <button id="add-btn" onclick="showAddModal()">+ Add Medication</button>
        </div>

        <div id="history-view" class="view">
            <h3>Intake History</h3>

            <div class="filters">
                <select id="history-filter-med" onchange="loadHistory()">
                    <option value="0">All Medications</option>
                </select>
                <select id="history-filter-days" onchange="loadHistory()">
                    <option value="1">Last 24 Hours</option>
                    <option value="3" selected>Last 3 Days</option>
                    <option value="7">Last 7 Days</option>
                </select>
            </div>

            <div id="history-list"></div>
        </div>

        <div id="bp-view" class="view">
            <h3>Blood Pressure Readings</h3>
            <div class="bp-actions">
                <button onclick="showBPRecordModal()" class="primary">+ Record BP</button>
            </div>
            <div id="bpChart"></div>
            <div id="bp-averages"></div>
            <ul id="bp-list"></ul>
        </div>

        <div id="weight-view" class="view">
            <h3>Weight Tracking</h3>
            <div class="weight-actions">
                <button onclick="showWeightModal()" class="primary">+ Log Weight</button>
            </div>
            <div id="weightChart"></div>
            <div id="weight-stats"></div>
            <ul id="weight-list"></ul>
        </div>

        <div id="workouts-view" class="view">
            <h3>üèãÔ∏è Workout Planner</h3>

            <!-- Tab Navigation for Workouts -->
            <div class="workout-tabs"
                style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                <button class="workout-tab active" onclick="switchWorkoutTab('groups')"
                    style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid #667eea;">
                    Groups
                </button>
                <button class="workout-tab" onclick="switchWorkoutTab('history')"
                    style="padding: 10px 20px; border: none; background: none; cursor: pointer;">
                    History
                </button>
                <button class="workout-tab" onclick="switchWorkoutTab('stats')"
                    style="padding: 10px 20px; border: none; background: none; cursor: pointer;">
                    Statistics
                </button>
            </div>

            <!-- Groups Management View -->
            <div id="workout-groups-tab" class="workout-tab-content">
                <!-- Next Workout Card -->
                <div id="next-workout-card"></div>

                <div style="margin-bottom: 15px;">
                    <button onclick="showAddWorkoutGroupModal()" class="primary">+ Add Workout Group</button>
                </div>
                <div id="workout-groups-list">
                    Loading workout groups...
                </div>
            </div>

            <!-- History View -->
            <div id="workout-history-tab" class="workout-tab-content" style="display: none;">
                <div id="workout-history-display">
                    Loading...
                </div>
            </div>

            <!-- Stats View -->
            <div id="workout-stats-tab" class="workout-tab-content" style="display: none;">
                <div id="workout-stats-display">
                    Loading...
                </div>
            </div>
        </div>

        <div id="settings-view" class="view">
            <h3>Settings</h3>

            <div id="oidc-setup-container"></div>

            <div class="setting-item">
                <div>
                    <h3>Web Push Notifications</h3>
                    <p class="setting-desc">Browser notifications for medications</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="webpush-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div id="webpush-status" style="display:none; padding: 8px; margin-top: 8px; border-radius: 4px;"></div>

            <div class="setting-item" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
                <div>
                    <h3>Test Notifications</h3>
                    <p class="setting-desc">Simulate upcoming notifications</p>
                </div>
                <button onclick="sendTestMedicationNotification()" class="secondary" style="margin: 0;">Send
                    Test</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal for Adding/Editing Workout Group -->
    <div id="workout-group-modal" class="hidden">
        <h3 id="workout-group-modal-title">Add Workout Group</h3>

        <input type="text" id="workout-group-name" placeholder="Group Name (e.g., Morning Cardio)">
        <textarea id="workout-group-description" placeholder="Description (optional)" rows="2"></textarea>

        <label class="checkbox-label">
            <input type="checkbox" id="workout-group-rotating" onchange="toggleRotatingFields()"> Rotating Workout
            (A/B/C/D)
        </label>

        <div class="form-row">
            <label>Days of Week:</label>
            <div class="days-select">
                <span data-day="1" onclick="toggleWorkoutDay(this)">Mon</span>
                <span data-day="2" onclick="toggleWorkoutDay(this)">Tue</span>
                <span data-day="3" onclick="toggleWorkoutDay(this)">Wed</span>
                <span data-day="4" onclick="toggleWorkoutDay(this)">Thu</span>
                <span data-day="5" onclick="toggleWorkoutDay(this)">Fri</span>
                <span data-day="6" onclick="toggleWorkoutDay(this)">Sat</span>
                <span data-day="0" onclick="toggleWorkoutDay(this)">Sun</span>
            </div>
        </div>

        <div class="form-row">
            <label>Scheduled Time:</label>
            <input type="time" id="workout-group-time">
        </div>

        <div class="form-row">
            <label>Notification (minutes before):</label>
            <input type="number" id="workout-group-notification" value="15" min="0" max="60">
        </div>

        <div class="form-row">
            <label class="checkbox-label">
                <input type="checkbox" id="workout-group-active" checked> Active
            </label>
        </div>

        <div class="actions">
            <button onclick="closeWorkoutGroupModal()" class="secondary">Cancel</button>
            <button onclick="saveWorkoutGroup()" class="primary">Save</button>
        </div>

        <!-- Variants Section (only shown when editing existing group) -->
        <div id="workout-variants-section"
            style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            <h4>Workout Variants</h4>
            <button onclick="showAddVariantModal()" class="primary" style="margin-bottom: 10px;">+ Add Variant</button>
            <div id="workout-variants-list"></div>
        </div>
    </div>

    <!-- Modal for Adding/Editing Variant -->
    <div id="workout-variant-modal" class="hidden">
        <h3 id="workout-variant-modal-title">Add Variant</h3>

        <input type="text" id="workout-variant-name" placeholder="Variant Name (e.g., Day A, Push Day)">
        <textarea id="workout-variant-description" placeholder="Description (optional)" rows="2"></textarea>

        <div id="workout-variant-rotation-field" style="display: none;">
            <div class="form-row">
                <label>Rotation Order:</label>
                <input type="number" id="workout-variant-rotation" min="0" placeholder="0 = first, 1 = second, etc.">
            </div>
        </div>

        <div class="actions">
            <button onclick="closeVariantModal()" class="secondary">Cancel</button>
            <button onclick="saveVariant()" class="primary">Save</button>
        </div>

        <!-- Exercises Section (only shown when editing existing variant) -->
        <div id="workout-exercises-section"
            style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            <h4>Exercises</h4>
            <button onclick="showAddExerciseModal()" class="primary" style="margin-bottom: 10px;">+ Add
                Exercise</button>
            <div id="workout-exercises-list"></div>
        </div>
    </div>

    <!-- Modal for Adding/Editing Exercise -->
    <div id="workout-exercise-modal" class="hidden">
        <h3 id="workout-exercise-modal-title">Add Exercise</h3>

        <input type="text" id="workout-exercise-name" placeholder="Exercise Name (e.g., Barbell Rows)">

        <div class="form-row">
            <label>Target Sets:</label>
            <input type="number" id="workout-exercise-sets" min="1" max="10" placeholder="4">
        </div>

        <div class="form-row">
            <label>Target Reps (Min):</label>
            <input type="number" id="workout-exercise-reps-min" min="1" max="100" placeholder="8">
        </div>

        <div class="form-row">
            <label>Target Reps (Max, optional):</label>
            <input type="number" id="workout-exercise-reps-max" min="1" max="100" placeholder="10">
        </div>

        <div class="form-row">
            <label>Target Weight (kg, optional):</label>
            <input type="number" id="workout-exercise-weight" step="0.5" min="0" placeholder="40">
        </div>

        <div class="form-row">
            <label>Order in workout:</label>
            <input type="number" id="workout-exercise-order" min="0" placeholder="0 = first, 1 = second, etc.">
        </div>

        <div class="actions">
            <button onclick="closeExerciseModal()" class="secondary">Cancel</button>
            <button onclick="saveExercise()" class="primary">Save</button>
        </div>
    </div>

    <!-- Modal for Workout Session Details -->
    <div id="workout-session-modal" class="hidden">
        <h3 id="workout-session-modal-title">Workout Details</h3>
        <div id="workout-session-info"
            style="margin-bottom: 15px; font-size: 0.9em; color: #666; background: #f0f0f0; padding: 10px; border-radius: 8px;">
        </div>
        <div id="workout-session-logs" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Exercise logs injected here -->
        </div>
        <div class="actions" style="margin-top: 20px;">
            <button onclick="closeWorkoutSessionModal()" class="secondary">Cancel</button>
            <button onclick="saveWorkoutSessionDetails()" class="primary">Save Changes</button>
        </div>
    </div>

    <!-- Modal for Adding Med -->
    <div id="modal-overlay" class="hidden"></div>
    <div id="med-modal" class="hidden">
        <h3>Add Medication</h3>
        <input type="text" id="med-name" placeholder="Name (e.g. Aspirin)">
        <input type="text" id="med-dosage" placeholder="Dosage (e.g. 100mg)">
        <p id="med-rx-display" style="font-size: 0.85em; color: var(--hint-color); margin-top: 5px; display: none;"></p>

        <label>Schedule Type:</label>
        <select id="schedule-type" onchange="toggleScheduleFields()">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="as_needed">As Needed</option>
        </select>

        <div id="days-container" class="hidden">
            <label>Days:</label>
            <div class="days-select">
                <span data-day="1" onclick="toggleDay(this)">Mon</span>
                <span data-day="2" onclick="toggleDay(this)">Tue</span>
                <span data-day="3" onclick="toggleDay(this)">Wed</span>
                <span data-day="4" onclick="toggleDay(this)">Thu</span>
                <span data-day="5" onclick="toggleDay(this)">Fri</span>
                <span data-day="6" onclick="toggleDay(this)">Sat</span>
                <span data-day="0" onclick="toggleDay(this)">Sun</span>
            </div>
        </div>

        <div id="times-container">
            <label>Times:</label>
            <div id="time-inputs">
                <div class="time-row">
                    <input type="time" class="med-time-input">
                    <button class="remove-time" onclick="removeTime(this)">√ó</button>
                </div>
            </div>
            <button class="small-btn" onclick="addTimeInput()">+ Add Time</button>
        </div>

        <div class="form-row">
            <label>Start Date (Optional):</label>
            <input type="date" id="med-start-date">
        </div>
        <div class="form-row">
            <label>End Date (Optional):</label>
            <input type="date" id="med-end-date">
        </div>

        <div class="inventory-section">
            <label class="checkbox-label">
                <input type="checkbox" id="med-track-inventory" onchange="toggleInventoryFields()"> Track Inventory
            </label>
            <div id="inventory-fields" class="hidden">
                <div class="form-row">
                    <label>Current Stock (doses):</label>
                    <input type="number" id="med-inventory-count" min="0" placeholder="e.g. 30">
                </div>
                <div id="restock-section">
                    <div class="form-row">
                        <label>Quick Restock:</label>
                        <div class="restock-row">
                            <input type="number" id="restock-qty" min="1" placeholder="Qty">
                            <button type="button" class="small-btn" onclick="handleRestock()">+ Add</button>
                        </div>
                    </div>
                    <div id="restock-history" class="restock-history"></div>
                </div>
            </div>
        </div>

        <div class="form-row">
            <label class="checkbox-label">
                <input type="checkbox" id="med-archived"> Archived
            </label>
        </div>

        <div class="actions">
            <button onclick="closeModal()" class="secondary">Cancel</button>
            <button onclick="saveMedication()" class="primary">Save</button>
        </div>
    </div>

    <!-- Modal for BP Recording -->
    <div id="bp-modal" class="hidden">
        <div class="modal-header">
            <h3 id="bp-modal-title">Record Blood Pressure</h3>
            <div class="actions">
                <button type="button" onclick="closeBPRecordModal()" class="secondary">Cancel</button>
                <button type="submit" form="bp-form" class="primary">Save</button>
            </div>
        </div>
        <form id="bp-form" onsubmit="handleBPSubmit(event)">
            <input type="datetime-local" id="bp-datetime" required>
            <div class="bp-inputs-row">
                <div class="bp-input-group">
                    <label>Systolic</label>
                    <input type="number" id="bp-systolic" min="60" max="250" placeholder="120" required
                        inputmode="numeric">
                </div>
                <div class="bp-input-group">
                    <label>Diastolic</label>
                    <input type="number" id="bp-diastolic" min="40" max="150" placeholder="80" required
                        inputmode="numeric">
                </div>
            </div>
            <div class="bp-inputs-row">
                <div class="bp-input-group">
                    <label>Pulse (optional)</label>
                    <input type="number" id="bp-pulse" min="30" max="250" placeholder="70" inputmode="numeric">
                </div>
            </div>
            <div class="form-row">
                <label>Site:</label>
                <select id="bp-site">
                    <option value="right_arm">Right Arm</option>
                    <option value="left_arm">Left Arm</option>
                </select>
            </div>
            <div class="form-row">
                <label>Position:</label>
                <select id="bp-position">
                    <option value="seated">Seated</option>
                    <option value="horizontal">Horizontal</option>
                </select>
            </div>
            <div class="form-row">
                <label>Notes:</label>
                <textarea id="bp-notes" placeholder="Any notes..." rows="3"></textarea>
            </div>
        </form>
    </div>

    <!-- Modal for Weight Logging -->
    <div id="weight-modal" class="hidden">
        <h3>Log Weight</h3>
        <form onsubmit="handleWeightSubmit(event)">
            <input type="datetime-local" id="weight-datetime" required>

            <!-- Editable weight input styled as large display -->
            <div class="weight-display-container">
                <div class="weight-display">
                    <input type="number" id="weight-value" step="0.1" min="30" max="300" class="weight-display-input"
                        inputmode="decimal" required>
                    <span class="weight-display-unit">kg</span>
                </div>
            </div>

            <!-- Interactive ruler component -->
            <div class="weight-ruler-container" id="weight-ruler-container">
                <div class="weight-ruler" id="weight-ruler">
                    <!-- Ticks will be generated by JavaScript -->
                </div>
                <div class="weight-ruler-indicator"></div>
            </div>

            <div class="form-row">
                <label>Notes (optional):</label>
                <textarea id="weight-notes" placeholder="Any notes..." rows="2"></textarea>
            </div>
            <div class="actions">
                <button type="button" onclick="closeWeightModal()" class="secondary">Cancel</button>
                <button type="submit" class="primary">Save</button>
            </div>
        </form>
    </div>

    <!-- Modal for Medication Confirmation (from Push) -->
    <div id="med-confirm-modal" class="hidden">
        <h3>Time for Meds!</h3>
        <p id="med-confirm-time" style="color: #666; margin-bottom: 15px;"></p>
        <div id="med-confirm-list" style="margin-bottom: 20px;">
            <!-- Checkboxes injected here -->
        </div>
        <div class="actions">
            <button onclick="snoozeMedicationConfirm()" class="secondary">Snooze 10m</button>
            <button onclick="confirmSelectedMedications()" class="primary">Confirm Selected</button>
        </div>
        <div style="margin-top: 10px; text-align: center;">
            <button onclick="closeMedicationConfirmModal()" class="text-btn" style="color: #999;">Dismiss</button>
        </div>
    </div>

    <!-- Modal for Workout Start (from Push) -->
    <div id="workout-start-modal" class="hidden">
        <h3 id="workout-start-title">Workout Time!</h3>
        <p id="workout-start-subtitle" style="color: #666; margin-bottom: 20px;"></p>

        <div class="actions" style="flex-direction: column; gap: 10px;">
            <button onclick="startWorkoutFromModal()" class="primary" style="width: 100%;">Start Workout</button>
            <button onclick="snoozeWorkout(60)" class="secondary" style="width: 100%;">Snooze 1 hour</button>
            <button onclick="snoozeWorkout(120)" class="secondary" style="width: 100%;">Snooze 2 hours</button>
            <button onclick="skipWorkoutFromModal()" class="danger"
                style="width: 100%; border-color: #ffcccb; color: #d32f2f;">Skip Workout</button>
        </div>
        <div style="margin-top: 15px; text-align: center;">
            <button onclick="closeWorkoutStartModal()" class="text-btn" style="color: #999;">Dismiss</button>
        </div>
    </div>

    <script src="static/js/db.js?v=TIMESTAMP_PLACEHOLDER"></script>
    <script src="static/js/sync.js?v=TIMESTAMP_PLACEHOLDER"></script>
    <script src="static/js/app.js?v=TIMESTAMP_PLACEHOLDER"></script>
    <script src="static/js/workout.js?v=TIMESTAMP_PLACEHOLDER"></script>
    <script src="static/js/push.js?v=TIMESTAMP_PLACEHOLDER"></script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/static/sw.js', {
                        scope: '/'
                    });
                    console.log('SW registered:', registration.scope);

                    // Check for updates
                    registration.onupdatefound = () => {
                        const newWorker = registration.installing;
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // New version found!
                                    console.log('New SW available, reloading...');
                                    window.location.reload();
                                }
                            }
                        };
                    };
                } catch (err) {
                    console.log('SW registration failed:', err);
                }
            });

            // Reload when the controller changes (e.g. after skipWaiting)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Controller changed, reloading...');
                window.location.reload();
            });
        }

        // Request persistent storage for Telegram WebApp context
        if (navigator.storage && navigator.storage.persist) {
            navigator.storage.persist().then(granted => {
                console.log('Persistent storage:', granted ? 'granted' : 'not granted');
            });
        }
    </script>
    <div style="text-align:center;color:var(--hint-color);font-size:10px;padding:10px;">
        v: VERSION_PLACEHOLDER
    </div>
</body>

</html>
